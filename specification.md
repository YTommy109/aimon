# Webアプリケーション仕様書 (改訂版)

## 1. 概要

このドキュメントは、AIツール連携Webアプリケーションの仕様を定義するものです。
このシステムは、**AIツールをAPIとして提供するAzure Functions**を呼び出して、ローカルファイルシステム上のテキストファイル群に対する処理を非同期に実行し、その進捗と結果を管理します。

## 2. システム構成

### 2.1. アーキテクチャ概要

- **フロントエンド**: Streamlitベースのユーザーインターフェース
- **バックエンド**:
  - Azure Functions上で動作するAIツール群
  - ローカルで動作する非同期処理エンジン
- **データストア**: ローカルファイルシステム上のJSONファイル

### 2.2. 開発環境

- **言語**: Python 3.12
- **パッケージ管理**: uv
- **フレームワーク**: Streamlit
- **開発スタイル**: スクリプトベースのアプリケーション
- **テスト**: pytest, pytest-playwright
- **静的解析・フォーマット**: ruff
- **タスクランナー**: just

### 2.3. ディレクトリ構成

```text
.
├── .data/               # プロジェクトデータ保存用
├── app/                 # アプリケーションのソースコード
├── log/                 # アプリケーションログ
├── tests/              # ユニット・インテグレーションテスト
├── tests-e2e/          # E2Eテスト
└── (その他設定ファイル群)
```

## 3. 機能要件

### 3.1. プロジェクト管理・実行UI

**目的**: ユーザーがAIツールの実行単位である「プロジェクト」を管理し、実行するためのUIを提供します。

**全体レイアウト**:

- 画面左側に「プロジェクト作成」フォームを配置したサイドバーを表示します。
- メインエリアに「プロジェクト一覧」を表示します。

**プロジェクト作成フォーム**:

- 入力項目:
  1. プロジェクト名 (テキスト入力)
  2. 対象ディレクトリのパス (テキスト入力)
  3. AIツール (ドロップダウン選択)
  - **`ai_tools.json`の中から`"disabled_at"`が`null`のツールのみを一覧表示します。**
- 「プロジェクト作成」ボタンを配置します。

**プロジェクト一覧表示**:

- **データソース**: `.data/projects.json`
- **ソート順**: 作成日時の新しいものが上に表示されます (降順)。
- **表示形式**: 各プロジェクトを行として表示します。
- **ヘッダー**: `No.`, `プロジェクト名`, `作成日時`, `実行日時`
- **各行のレイアウト**:
    1. **No.** (`small`幅): 1からの連番。
    2. **プロジェクト名** (`large`幅): プロジェクト名の前に、現在のステータスを示すアイコンをプレフィックスとして付与します。
        - 💬: 待機中 (Pending)
        - 🏃: 実行指示受領直後 (Running)
        - ⏳: 処理中 (Processing)
        - ✅: 完了 (Completed)
        - ❌: 失敗 (Failed)
    3. **作成日時** (`medium`幅): `YYYY/MM/DD HH:mm`形式。
    4. **実行日時** (`medium`幅): `YYYY/MM/DD HH:mm`形式。
    5. **詳細ボタン**: 各行の末尾に「詳細」ボタンを配置します。
    6. **実行ボタン**: 各行の「詳細」ボタンの横に「実行」ボタンを配置します。実行可能なプロジェクト（ステータスがPendingのもの）のみ表示し、実行開始後は非表示とします。

**詳細表示**:

- 「詳細」ボタンをクリックすると、**モーダルダイアログ**が開き、そのプロジェクトに関する以下の詳細情報が表示されます。
  - UUID
  - 対象パス
  - AIツール名
  - 詳細なステータス (テキスト)
  - 作成、実行、終了の各日時

### 3.2. AIツール実行機能

- **実行エンジン**:
  - AIツールは**Azure FunctionsのAPIエンドポイント**として提供され、本アプリケーションはそれを呼び出します。
  - **注**: 開発段階では、Azure Functions環境が未整備のため、暫定的にGoogle Gemini APIを直接呼び出して代替しています。
- **処理フロー**:
    1. 指定された「対象ディレクトリのパス」内にあるすべての`.txt`および`.xlsx`ファイルを処理対象とします。
    2. 各ファイルの内容を読み込み、Azure Functions上のAIツールに送信します。
    3. APIから得られた結果を、対象ディレクトリ内に適切なファイル名で保存します。
    4. 処理が完了したら、プロジェクトのステータスを「完了」に更新し、終了日時を記録します。

### 3.3. AIツール管理機能

**目的**: ユーザーがシステムで利用可能なAIツールを登録、編集、削除できるUIを提供します。

**UI配置**:

- プロジェクト管理UIとは別のページ、もしくはタブで提供します。「AIツール管理」のようなナビゲーションを設けます。

**機能**:

- **AIツール一覧表示**:
  - `ai_tools.json` に登録されているAIツールを一覧で表示します。
  - 表示項目: `ID`, `ツール名`, `説明`, `登録日時`, `最終更新日時`, `状態`
  - 各行に「編集」「無効化/有効化」ボタンを配置します。
- **AIツール登録**:
  - 「新規ツール登録」ボタンを配置します。
  - ボタンを押すとモーダルダイアログが開き、以下の項目を入力させます。
    - ツールID (`id`): 半角英数字とハイフンのみ。
    - ツール名 (`name_ja`)
    - 説明 (`description`)
- **AIツール編集**:
  - 「編集」ボタンを押すと、登録時と同様のモーダルが開き、既存の情報を編集できます。
- **AIツール状態変更**:
  - ボタンは現在の状態に応じて「無効化」または「有効化」と表示されます。
  - **物理的な削除は行わず、論理削除のみとします。**

## 4. データ構造

### 4.1. AIツール定義

- **目的**: システムで利用可能なAIツールの定義を管理します。
- **形式**: JSON
- **主要項目**:
  - ツールID (一意の識別子)
  - ツール名 (日本語)
  - 説明文
  - 作成日時
  - 更新日時
  - 無効化日時 (論理削除用)

### 4.2. プロジェクト管理

- **目的**: AIツール実行の単位となるプロジェクトの状態を管理します。
- **形式**: JSON
- **主要項目**:
  - プロジェクトID (UUID)
  - プロジェクト名
  - 対象ディレクトリパス
  - 使用AIツールID
  - ステータス
  - 処理結果
  - 各種タイムスタンプ

## 5. テスト戦略

### 5.1. テストレベル

1. **ユニットテスト**:
   - 対象: 個別のモジュールやクラス
   - ツール: pytest
   - カバレッジ目標: 80%以上

2. **インテグレーションテスト**:
   - 対象: モジュール間の連携、外部APIとの通信
   - 特記: Azure Functions環境が未整備の間は、モックを使用

3. **E2Eテスト**:
   - 対象: ユーザーインターフェースを含むシステム全体
   - ツール: pytest-playwright
   - 環境: 専用のテストデータディレクトリを使用

### 5.2. テストデータ管理

- **基本方針**: テストの再現性と保守性を確保するため、テストデータは原則として動的に生成
- **例外**: 複雑なExcelファイルなど、動的生成が困難なものは `tests/fixtures/` に配置

## 6. 非機能要件

### 6.1. エラー処理とユーザー体験

- **エラーメッセージ**:
  - すべてのエラーメッセージは日本語で表示
  - ユーザーが取るべきアクションを明確に提示
  - 技術的なスタックトレースは開発者向けログにのみ記録

- **処理の継続性**:
  - 一つのファイルの処理失敗が他のファイルの処理に影響しないよう分離
  - 処理結果には成功・失敗の両方の情報を含める

### 6.2. パフォーマンス要件

- **応答時間**:
  - UI操作の応答: 1秒以内
  - プロジェクト一覧の更新: 3秒以内

- **同時実行**:
  - 複数プロジェクトの並行実行をサポート
  - システムリソースに応じた実行数の制御

### 6.3. データ永続化要件

- **データの整合性**:
  - プロジェクト状態の一貫性保証
  - 予期せぬシステム終了時のデータ保護

- **バックアップと復旧**:
  - プロジェクトデータの定期バックアップ
  - 最後の既知の正常状態への復旧機能

### 6.4. セキュリティ要件

- **API認証情報**:
  - 認証情報の安全な管理
  - ログやエラーメッセージでの機密情報の保護

- **ファイルアクセス**:
  - 処理対象ディレクトリの適切な制限
  - システムファイルやセキュリティ上重要なファイルへのアクセス防止
