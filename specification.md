# Webアプリケーション仕様書 (改訂版)

## 1. 概要

このドキュメントは、AIツール連携Webアプリケーションの仕様を定義するものです。
このシステムは、**Google Gemini API** を利用して、ローカルファイルシステム上のテキストファイル群に対する処理を非同期に実行し、その進捗と結果を管理します。

## 2. 採用技術・開発スタイル

- **プログラミング言語**: Python 3.12
- **パッケージ管理**: uv
- **フレームワーク**: Streamlit
- **開発スタイル**:
  - 本プロジェクトは、**パッケージとしてインストール（`pip install -e .`）しない**、スクリプトベースのアプリケーションとします。
  - 実行やテストの際は、プロジェクトルートから`python -m`経由で各モジュールを呼び出します。
- **環境変数管理**: direnv
- **テスト**: pytest, pytest-cov
- **静的解析・フォーマット**: ruff
- **タスクランナー**: just. `justfile`には最低限以下のレシピを定義します。
  - `run`: アプリケーションを起動する。
  - `test`: ユニットテストを実行する。
  - `coverage`: テストカバレッジを計測する。
  - `lint`: 静的解析を実行する。
  - `format`: コードをフォーマットする。
  - `sync`: 依存関係をインストール/同期する。

## 3. 機能要件

### 3.1. プロジェクト管理・実行UI

**目的**: ユーザーがAIツールの実行単位である「プロジェクト」を管理し、実行するためのUIを提供します。

**全体レイアウト**:

- 画面左側に「プロジェクト作成」フォームを配置したサイドバーを表示します。
- メインエリアに「プロジェクト一覧」を表示します。

**プロジェクト作成フォーム**:

- 入力項目:
  1. プロジェクト名 (テキスト入力)
  2. 対象ディレクトリのパス (テキスト入力)
  3. AIツール (ドロップダウン選択)
- 「プロジェクト作成」ボタンを配置します。

**プロジェクト一覧表示**:

- **ソート順**: 作成日時の新しいものが上に表示されます (降順)。
- **表示形式**: テーブル形式ではなく、各プロジェクトを行として表示します。
- **ヘッダー**: `No.`, `プロジェクト名`, `作成日時`, `実行日時`
- **各行のレイアウト**: 以下の要素を左から順にカラムで表示します。
    1. **No.** (`small`幅): 1からの連番。
    2. **プロジェクト名** (`large`幅): プロジェクト名の前に、現在のステータスを示すアイコンをプレフィックスとして付与します。
        - 💬: 待機中 (Pending)
        - 🏃: 実行指示受領直後 (Running)
        - ⏳: 処理中 (Processing)
        - ✅: 完了 (Completed)
        - ❌: 失敗 (Failed)
    3. **作成日時** (`medium`幅): `YYYY/MM/DD HH:mm`形式。
    4. **実行日時** (`medium`幅): `YYYY/MM/DD HH:mm`形式。
    5. **詳細ボタン**: 各行の末尾に「詳細」ボタンを配置します。
- **詳細表示**:
  - 「詳細」ボタンをクリックすると、**モーダルダイアログ**が開き、そのプロジェクトに関する以下の詳細情報が表示されます。
    - UUID
    - 対象パス
    - AIツール名
    - 詳細なステータス (テキスト)
    - 作成、実行、終了の各日時

### 3.2. AIツール実行機能

- **実行エンジン**: Google Gemini API (`gemini-1.5-flash`モデル) を使用します。
- **APIキー**: Gemini APIキーは、環境変数 `GEMINI_API_KEY` から取得します。
- **処理フロー**:
    1. 指定された「対象ディレクトリのパス」内にあるすべての`.txt`ファイルを処理対象とします。
    2. 各ファイルの内容を読み込み、「この文章を日本語で3行で要約してください。」という固定プロンプトと共にGemini APIへ送信します。
    3. APIから得られた要約結果を、対象ディレクトリ内に`gemini_results.md`というファイル名で追記保存します。
    4. 処理が完了したら、プロジェクトのステータスを「完了」に更新し、終了日時を記録します。

### 3.3. AIツール管理機能

**目的**: ユーザーがシステムで利用可能なAIツールを登録、編集、削除できるUIを提供します。

**UI配置**:

- プロジェクト管理UIとは別のページ、もしくはタブで提供します。「AIツール管理」のようなナビゲーションを設けます。

**機能**:

- **AIツール一覧表示**:
  - `ai_tools.json` に登録されているAIツールを一覧で表示します。
  - 表示項目: `ID`, `ツール名`, `説明`
  - 各行に「編集」「削除」ボタンを配置します。
- **AIツール登録**:
  - 「新規ツール登録」ボタンを配置します。
  - ボタンを押すとモーダルダイアログが開き、以下の項目を入力させます。
    - ツールID (`id`): 半角英数字とハイフンのみ。
    - ツール名 (`name_ja`)
    - 説明 (`description`)
  - 「登録」ボタンで`ai_tools.json`に追記します。
- **AIツール編集**:
  - 「編集」ボタンを押すと、登録時と同様のモーダルが開き、既存の情報を編集できます。
- **AIツール削除**:
  - 「削除」ボタンを押すと、確認ダイアログを表示したのち、`ai_tools.json`から該当ツールを削除します。

## 4. データ形式の定義

### 4.1. AIツール管理JSON (`ai_tools.json`)

```json
[
  {
    "id": "gemini-summarize-jp",
    "name_ja": "Gemini 日本語要約",
    "description": "Gemini-1.5-Flash を利用して日本語の文章を3行で要約します。"
  }
]
```

### 4.2. プロジェクト管理JSON (`projects.json`)

```json
[
  {
    "id": "uuid-goes-here-1",
    "name": "月次報告書の要約",
    "source": "/path/to/your/files",
    "ai_tool": "gemini-summarize-jp",
    "status": "Completed",
    "result": {
      "processed_files": ["report.txt"],
      "message": "Processing successful. Results saved to gemini_results.md"
    },
    "created_at": "2023-10-27T10:00:00Z",
    "executed_at": "2023-10-27T10:05:00Z",
    "finished_at": "2023-10-27T10:15:00Z"
  }
]
```

## 5. その他

- **ロギング**: Python標準の`logging`モジュールを使用し、ログは`log/`ディレクトリ配下に保存します。
- **テスト**: ユニットテスト/インテグレーションテストを`pytest`で実装します。UIロジックは`page_logic.py`に分離し、カバレッジを確保します。UI自体のE2Eテストは行いません。
