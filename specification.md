# Webアプリケーション仕様書 (改訂版)

## 1. 概要

このドキュメントは、AIツール連携Webアプリケーションの仕様を定義するものです。
このシステムは、**Google Gemini API** を利用して、ローカルファイルシステム上のテキストファイル群に対する処理を非同期に実行し、その進捗と結果を管理します。

## 2. 採用技術・開発スタイル

- **プログラミング言語**: Python 3.12
- **パッケージ管理**: uv
- **フレームワーク**: Streamlit
- **開発スタイル**:
  - 本プロジェクトは、**パッケージとしてインストール（`pip install -e .`）しない**、スクリプトベースのアプリケーションとします。
- **環境変数管理**: direnv
- **テスト**: pytest, pytest-cov, pytest-playwright
- **静的解析・フォーマット**: ruff
- **タスクランナー**: just

### 2.1. 開発ワークフローとコマンド実行

- **仮想環境**: `uv venv`で作成された仮想環境 (`.venv`) を有効化 (`source .venv/bin/activate`) して作業することを前提とします。
- **コマンド実行**: Pythonスクリプトや`pytest`のようなツールは、モジュール解決の安定性のため、原則として`python -m <module>`の形式で実行します。
- **タスクランナー**: `justfile`に定義されたレシピ（`run`, `run-test`, `test`, `test-e2e`, `lint`等）を積極的に利用します。

### 2.2. 主要なディレクトリ・ファイル構成

```text
.
├── .data/
│   └── projects.json      # プロジェクトの状態を保存する
├── .data_test/
│   └── projects.json      # E2Eテスト実行時に使用される
├── app/                   # アプリケーションのソースコード
│   ├── __init__.py
│   ├── main_page.py       # StreamlitのUI定義
│   └── (その他)
├── log/
│   └── app.log            # アプリケーションログ
├── tests/                 # ユニット/インテグレーションテスト
├── tests-ci/              # CI用のインテグレーションテスト
├── tests-e2e/             # E2Eテスト
├── app.py                 # アプリケーションのエントリポイント
├── justfile               # タスクランナー設定
├── specification.md       # このファイル
└── (その他)
```

## 3. 機能要件

### 3.1. プロジェクト管理・実行UI

**目的**: ユーザーがAIツールの実行単位である「プロジェクト」を管理し、実行するためのUIを提供します。

**全体レイアウト**:

- 画面左側に「プロジェクト作成」フォームを配置したサイドバーを表示します。
- メインエリアに「プロジェクト一覧」を表示します。

**プロジェクト作成フォーム**:

- 入力項目:
  1. プロジェクト名 (テキスト入力)
  2. 対象ディレクトリのパス (テキスト入力)
  3. AIツール (ドロップダウン選択)
- 「プロジェクト作成」ボタンを配置します。

**プロジェクト一覧表示**:

- **データソース**: `.data/projects.json`
- **ソート順**: 作成日時の新しいものが上に表示されます (降順)。
- **表示形式**: テーブル形式ではなく、各プロジェクトを行として表示します。
- **ヘッダー**: `No.`, `プロジェクト名`, `作成日時`, `実行日時`
- **各行のレイアウト**: 以下の要素を左から順にカラムで表示します。
    1. **No.** (`small`幅): 1からの連番。
    2. **プロジェクト名** (`large`幅): プロジェクト名の前に、現在のステータスを示すアイコンをプレフィックスとして付与します。
        - 💬: 待機中 (Pending)
        - 🏃: 実行指示受領直後 (Running)
        - ⏳: 処理中 (Processing)
        - ✅: 完了 (Completed)
        - ❌: 失敗 (Failed)
    3. **作成日時** (`medium`幅): `YYYY/MM/DD HH:mm`形式。
    4. **実行日時** (`medium`幅): `YYYY/MM/DD HH:mm`形式。
    5. **詳細ボタン**: 各行の末尾に「詳細」ボタンを配置します。
- **詳細表示**:
  - 「詳細」ボタンをクリックすると、**モーダルダイアログ**が開き、そのプロジェクトに関する以下の詳細情報が表示されます。
    - UUID
    - 対象パス
    - AIツール名
    - 詳細なステータス (テキスト)
    - 作成、実行、終了の各日時

### 3.2. AIツール実行機能

- **実行エンジン**: Google Gemini API (`gemini-1.5-flash`モデル) を使用します。
- **APIキー**: Gemini APIキーは、環境変数 `GEMINI_API_KEY` から取得します。
- **処理フロー**:
    1. 指定された「対象ディレクトリのパス」内にあるすべての`.txt`ファイルを処理対象とします。
    2. 各ファイルの内容を読み込み、「この文章を日本語で3行で要約してください。」という固定プロンプトと共にGemini APIへ送信します。
    3. APIから得られた要約結果を、対象ディレクトリ内に`gemini_results.md`というファイル名で追記保存します。
    4. 処理が完了したら、プロジェクトのステータスを「完了」に更新し、終了日時を記録します。

### 3.3. AIツール管理機能

**目的**: ユーザーがシステムで利用可能なAIツールを登録、編集、削除できるUIを提供します。

**UI配置**:

- プロジェクト管理UIとは別のページ、もしくはタブで提供します。「AIツール管理」のようなナビゲーションを設けます。

**機能**:

- **AIツール一覧表示**:
  - `ai_tools.json` に登録されているAIツールを一覧で表示します。
  - 表示項目: `ID`, `ツール名`, `説明`
  - 各行に「編集」「削除」ボタンを配置します。
- **AIツール登録**:
  - 「新規ツール登録」ボタンを配置します。
  - ボタンを押すとモーダルダイアログが開き、以下の項目を入力させます。
    - ツールID (`id`): 半角英数字とハイフンのみ。
    - ツール名 (`name_ja`)
    - 説明 (`description`)
  - 「登録」ボタンで`ai_tools.json`に追記します。
- **AIツール編集**:
  - 「編集」ボタンを押すと、登録時と同様のモーダルが開き、既存の情報を編集できます。
- **AIツール削除**:
  - 「削除」ボタンを押すと、確認ダイアログを表示したのち、`ai_tools.json`から該当ツールを削除します。

## 4. データ形式の定義

### 4.1. AIツール管理JSON (`ai_tools.json`)

- **パス**: プロジェクトルート/ai_tools.json

```json
[
  {
    "id": "gemini-summarize-jp",
    "name_ja": "Gemini 日本語要約",
    "description": "Gemini-1.5-Flash を利用して日本語の文章を3行で要約します。"
  }
]
```

### 4.2. プロジェクト管理JSON (`projects.json`)

- **パス**:
  - 開発環境: `.data/projects.json`
  - テスト環境: `.data_test/projects.json`

```json
[
  {
    "id": "uuid-goes-here-1",
    "name": "月次報告書の要約",
    "source": "/path/to/your/files",
    "ai_tool": "gemini-summarize-jp",
    "status": "Completed",
    "result": {
      "processed_files": ["report.txt"],
      "message": "Processing successful. Results saved to gemini_results.md"
    },
    "created_at": "2023-10-27T10:00:00Z",
    "executed_at": "2023-10-27T10:05:00Z",
    "finished_at": "2023-10-27T10:15:00Z"
  }
]
```

## 5. テスト戦略

### 5.1. ユニットテスト / インテグレーションテスト

- **ロギング**: Python標準の`logging`モジュールを使用し、ログは`log/`ディレクトリ配下に保存します。
- `pytest`を用いて実装します。UIロジックは`page_logic.py`に分離し、カバレッジを確保します。

### 5.2. E2Eテスト (End-to-End Test)

- **基本方針**: E2Eテストは、**開発者が手動でWebアプリケーションをテストモードで起動した状態**で、別のターミナルからテストスイートを実行することを想定しています。テストコード自身はアプリケーションの起動・停止を管理しません。これにより、開発用のデータを破壊することなく安全にテストを実行できます。
- **実行手順**:
  1. **ターミナル1**: アプリケーションを**テストモード**で起動します。

     ```bash
     # test用のポート(8502)で、テスト用のデータディレクトリ(.data_test)を使用する
     just run-test
     ```

  2. **ターミナル2**: E2Eテストを実行します。

     ```bash
     just test-e2e
     ```

- **テストの責務**:
  - テスト実行前に、`conftest.py`内のフィクスチャがテスト用データディレクトリ (`.data_test/`) をクリーンアップします。
  - テストは `http://localhost:8502` で実行されているアプリケーションに対して行われます。
