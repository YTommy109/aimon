# Webアプリケーション仕様書 (改訂版)

## 1. 概要

このドキュメントは、AIツール連携Webアプリケーションの仕様を定義するものです。
本仕様では、外部のUnixコマンドとしてのAIツール実行方式を廃止し、
アプリ内部にAIツール（要約・レビュー）を内包します。
LLM へのアクセスは provider-agnostic なクライアント
（lightllm/LiteLLM 想定）を介して OpenAI / Gemini / 社内 LLM を
切り替え可能とします。処理はローカルファイルシステム上の
ファイル群に対して非同期に実行し、その進捗と結果を管理します。

## 2. システム構成

### 2.1. アーキテクチャ概要

- **フロントエンド**: Streamlitベースのユーザーインターフェース
- **バックエンド**:
  - アプリ内蔵のAIツール群（要約: OVERVIEW、レビュー: REVIEW）
  - LLM クライアント（lightllm/LiteLLM）により OpenAI / Gemini / 社内 LLM を切替
  - ローカルで動作する非同期処理エンジン
- **データストア**: ローカルファイルシステム上のJSONファイル

### 2.2. アーキテクチャ図

```mermaid
graph TB
    subgraph "View Layer"
        UI[Streamlit UI]
    end

    subgraph "UI Layer"
        MP[MainPage]
        DM[DataManager]
        PP[ProjectProcessor]
        TH[ToolHandler]
        PH[ProjectHandler]
        PS[ProjectService]
        TS[ToolService]
    end

    subgraph "Domain Layer"
        E[Entities]
        R[Repositories Interface]
    end

    subgraph "Infrastructure Layer"
        JPR[JsonProjectRepository]
        FP[FileProcessor]
        LC[LLMClient (lightllm)]
    end

    subgraph "External"
        LLM[LLM Providers\n(OpenAI/Gemini/社内LLM)]
        FS[File System]
    end

    UI --> MP
    MP --> PS
    MP --> TS
    PS --> JPR
    TS --> LC
    JPR --> E
    FP --> FS
    LC --> LLM
```

### 2.3. レイヤー別責務

#### View Layer (UI層)

- **責務**: ユーザーインターフェースの表示とユーザー入力の処理
- **主要コンポーネント**:
  - `main_page.py`: メインページのUI統合
  - `ui/`: Streamlit用UIコンポーネント群

#### Service Layer (サービス層)

- **責務**: ビジネスロジックの実装
- **主要コンポーネント**:
  - `ProjectService`: プロジェクト管理のビジネスロジック

#### Domain Layer (ドメイン層)

- **責務**: ビジネスルールとエンティティの定義
- **主要コンポーネント**:
  - `models/`: ドメインモデル（Project）
  - `repositories/`: リポジトリインターフェース

#### Infrastructure Layer (インフラストラクチャ層)

- **責務**: 外部システムとの連携とデータ永続化
- **主要コンポーネント**:
  - `JsonProjectRepository`: プロジェクトデータのJSON永続化
  - `FileProcessor`: ファイル処理ロジック
  - `LLMClient`: LLM プロバイダ（OpenAI/Gemini/社内）を lightllm 経由で呼び出すクライアント

### 2.4. 開発環境

- **言語**: Python 3.12
- **パッケージ管理**: uv
- **フレームワーク**: Streamlit
- **開発スタイル**: スクリプトベースのアプリケーション
- **テスト**: pytest, pytest-playwright
- **静的解析・フォーマット**: ruff
- **タスクランナー**: just

### 2.6. 環境設定と切り替え

- **環境ファイル**: direnv 依存は廃止し、`.env` 系ファイルを使用します。
  - 本番環境: `.env`
  - 開発環境: `.env.dev`
  - テスト環境: `.env.test`
- **切り替え方法**: 以下の2通りに対応します。
  1. 環境変数 `ENV` に `prod` | `dev` | `test` を設定
  2. Streamlit 起動オプションで `-- --app-env <prod|dev|test>` を指定
- **優先順位**: 明示的に指定された起動オプションが最優先、その次に `ENV`、いずれも未指定の場合は `dev` を既定とします。
- **読み込み規約**: 有効な環境に応じて上記の `.env*` を読み込み、API キーやプロバイダ設定（OpenAI/Gemini/社内 LLM のエンドポイント等）を解決します。

### 2.5. ディレクトリ構成

```text
.
├── .data/               # プロジェクトデータ保存用（JSONファイル）
├── app/                 # アプリケーションのソースコード
│   ├── models/          # ドメインモデル（Project）
│   ├── repositories/    # リポジトリ実装
│   ├── services/        # サービス層（ビジネスロジック）
│   ├── ui/              # UI層（Streamlit用）
│   ├── utils/           # ユーティリティ（excel_parser.py）
│   ├── config.py        # 設定管理
│   ├── errors.py        # エラー定義
│   ├── logger.py        # ログ設定
│   └── main_page.py     # メインページUI
├── log/                 # アプリケーションログ
├── tests/               # ユニット・インテグレーションテスト
├── tests_e2e/           # E2Eテスト
└── (その他設定ファイル群)
```

## 3. 機能要件

### 3.1. プロジェクト管理・実行UI

**目的**: ユーザーがAIツールの実行単位である「プロジェクト」を管理し、実行するためのUIを提供します。

**全体レイアウト**:

- 画面左側に「プロジェクト作成」フォームを配置したサイドバーを表示します。
- メインエリアに「プロジェクト一覧」を表示します。

**プロジェクト作成フォーム**:

- 入力項目:
  1. プロジェクト名 (テキスト入力)
  2. 対象ディレクトリのパス (テキスト入力)
  3. AIツール (ドロップダウン選択)
  - 内蔵ツールのうち `OVERVIEW`（要約）または `REVIEW`（レビュー）を選択します。
- 「プロジェクト作成」ボタンを配置します。

**プロジェクト一覧表示**:

- **データソース**: `.data/projects.json`
- **ソート順**: 作成日時の新しいものが上に表示されます (降順)。
- **表示形式**: 各プロジェクトを行として表示します。
- **ヘッダー**: `No.`, `プロジェクト名`, `作成日時`, `実行日時`
- **各行のレイアウト**:
    1. **No.** (`small`幅): 1からの連番。
    2. **プロジェクト名** (`large`幅): プロジェクト名の前に、現在のステータスを示すアイコンをプレフィックスとして付与します。
        - 💬: 待機中 (Pending)
        - 🏃: 実行指示受領直後 (Running)
        - ⏳: 処理中 (Processing)
        - ✅: 完了 (Completed)
        - ❌: 失敗 (Failed)
    3. **作成日時** (`medium`幅): `YYYY/MM/DD HH:mm`形式。
    4. **実行日時** (`medium`幅): `YYYY/MM/DD HH:mm`形式。
    5. **詳細ボタン**: 各行の末尾に「詳細」ボタンを配置します。
    6. **実行ボタン**: 各行の「詳細」ボタンの横に「実行」ボタンを配置します。実行可能なプロジェクト（ステータスがPendingのもの）のみ表示し、実行開始後は非表示とします。

**詳細表示**:

- 「詳細」ボタンをクリックすると、**モーダルダイアログ**が開き、そのプロジェクトに関する以下の詳細情報が表示されます。
  - UUID
  - 対象パス
  - AIツール名
  - 詳細なステータス (テキスト)
  - 作成、実行、終了の各日時

### 3.2. AIツール実行機能

- **内蔵ツール**:
  - `OVERVIEW`: ディレクトリ内のドキュメント群を要約し、全体像・主要論点・アクションを抽出
  - `REVIEW`: 指定ドキュメントをレビューし、改善提案・指摘事項・整合性チェックを出力
- **LLM 切替**:
  - lightllm/LiteLLM を通じて OpenAI / Gemini / 社内 LLM を選択可能（環境変数・.env で設定）
- **処理フロー**:
  1. ユーザーが `OVERVIEW` または `REVIEW` を選択し、対象ディレクトリを指定
  2. ファイルを収集・前処理（サイズ/数に応じた分割・要約等を含む）
  3. プロンプトを生成し、`LLMClient` を介して LLM に問い合わせ
  4. 出力結果を対象ディレクトリ内の適切なファイル名で保存
  5. プロジェクトのステータスを更新し、終了日時を記録

### 3.3. 内蔵AIツール仕様（管理UIなし）

本バージョンでは外部定義や管理UIを持たず、内蔵の2ツールのみを提供します。

- 選択肢: `OVERVIEW`（要約）, `REVIEW`（レビュー）
- 将来の拡張でツール追加・管理UI復活を検討しますが、当面は固定とします。

## 4. データ構造

### 4.1. 内蔵AIツールの識別子

- **定義**: `StrEnum` で `ToolType` を定義し、以下の2値を持ちます。
  - `OVERVIEW`
  - `REVIEW`
- **備考**: 将来的な拡張時も `StrEnum` を拡張することで識別子の一貫性を保ちます。

### 4.2. プロジェクト管理

- **目的**: AIツール実行の単位となるプロジェクトの状態を管理します。
- **形式**: JSON
- **主要項目**:
  - プロジェクトID (UUID)
  - プロジェクト名
  - 対象ディレクトリパス
  - 使用AIツール識別子（`ToolType`: `OVERVIEW` | `REVIEW`）
  - ステータス
  - 処理結果
  - 各種タイムスタンプ

- **例（抜粋）**:

```json
{
  "id": "2f6a6c7c-9a5e-4d71-9a8f-55f7d2f5e1a1",
  "name": "要約-週次報告",
  "target_path": "/path/to/dir",
  "tool": "OVERVIEW",
  "status": "Pending",
  "created_at": "2025-08-06T12:00:00+09:00",
  "started_at": null,
  "finished_at": null
}
```

## 5. テスト戦略

### 5.1. テストレベル

1. **ユニットテスト**:
   - 対象: 個別のモジュールやクラス
   - ツール: pytest
   - カバレッジ目標: 80%以上

2. **インテグレーションテスト**:
   - 対象: モジュール間の連携、LLM クライアントとの通信
   - 特記: LLM 呼び出しはモック（lightllm/LiteLLM のラッパをパッチ）

3. **E2Eテスト**:
   - 対象: ユーザーインターフェースを含むシステム全体
   - ツール: pytest-playwright
   - 環境: 専用のテストデータディレクトリを使用

### 5.2. テストデータ管理

- **基本方針**: テストの再現性と保守性を確保するため、テストデータは原則として動的に生成
- **例外**: 複雑なExcelファイルなど、動的生成が困難なものは `tests/fixtures/` に配置

## 6. 非機能要件

### 6.1. エラー処理とユーザー体験

- **エラーメッセージ**:
  - すべてのエラーメッセージは日本語で表示
  - ユーザーが取るべきアクションを明確に提示
  - 技術的なスタックトレースは開発者向けログにのみ記録

- **処理の継続性**:
  - 一つのファイルの処理失敗が他のファイルの処理に影響しないよう分離
  - 処理結果には成功・失敗の両方の情報を含める

### 6.2. パフォーマンス要件

- **応答時間**:
  - UI操作の応答: 1秒以内
  - プロジェクト一覧の更新: 3秒以内

- **同時実行**:
  - 複数プロジェクトの並行実行をサポート
  - システムリソースに応じた実行数の制御

### 6.3. データ永続化要件

- **データの整合性**:
  - プロジェクト状態の一貫性保証
  - 予期せぬシステム終了時のデータ保護

- **バックアップと復旧**:
  - プロジェクトデータの定期バックアップ
  - 最後の既知の正常状態への復旧機能

### 6.4. セキュリティ要件

- **コマンド実行**:
  - 実行するコマンドの適切な検証
  - 危険なコマンドの実行防止
  - ログやエラーメッセージでの機密情報の保護

- **ファイルアクセス**:
  - 処理対象ディレクトリの適切な制限
  - システムファイルやセキュリティ上重要なファイルへのアクセス防止
